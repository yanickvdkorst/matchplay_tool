<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <title>Golf Matchplay Dashboard</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    table { border-collapse: collapse; margin-top: 20px; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 5px 10px; text-align: center; }
    a { text-decoration: none; color: blue; }
    input { margin: 0 5px; }
    button { margin-left: 10px; }
  </style>
</head>
<body>
  <h1>Golf Matchplay Dashboard</h1>

  <!-- Nieuw formulier om match toe te voegen -->
  <div>
    <label>Speler 1: <input type="text" id="newPlayer1"></label>
    <label>Speler 2: <input type="text" id="newPlayer2"></label>
    <button id="addMatchBtn">Nieuwe wedstrijd starten</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>Score</th>
        <th>Speler 1</th>
        <th>Hole</th>
        <th>Speler 2</th>
        <th>Score</th>
        <th>Actie</th>
      </tr>
    </thead>
    <tbody id="matchesBody">
      <!-- Dynamische matches komen hier -->
    </tbody>
  </table>

  <script>
    const apiUrl = "http://localhost:5050";
    const matchesBody = document.getElementById("matchesBody");
    const addMatchBtn = document.getElementById("addMatchBtn");
    const newPlayer1Input = document.getElementById("newPlayer1");
    const newPlayer2Input = document.getElementById("newPlayer2");

    // Berekening van live UP-score
    function calculateUpScore(holes) {
      let score1 = 0;
      let score2 = 0;

     holes.forEach(h => {
        if (h.winner === 1) score1++;
        if (h.winner === 2) score2++;
        // winner === 0 --> gelijkspel, niet tellen
        });

      const diff = score1 - score2;
      if (diff > 0) return { player1Up: `${diff}UP`, player2Up: "" };
      if (diff < 0) return { player1Up: "", player2Up: `${-diff}UP` };
      return { player1Up: "", player2Up: "" };
    }

   function getCurrentHole(holes) {
  const nextHole = holes.find(h => h.winner === null); // nog niet gespeeld
  return nextHole ? nextHole.hole_number : "Einde match";
}

    async function loadDashboard() {
      const res = await fetch(`${apiUrl}/matches`);
      const matches = await res.json();
      matchesBody.innerHTML = "";

      for (let m of matches) {
  const holesRes = await fetch(`${apiUrl}/matches/${m.id}/score`);
  const holes = await holesRes.json();

  const upScore = calculateUpScore(holes);
  const currentHole = getCurrentHole(holes); // juiste huidige hole

  const row = document.createElement("tr");
  row.innerHTML = `
    <td>${upScore.player1Up}</td>
    <td>${m.player1_name}</td>
    <td>${getCurrentHole(holes)}</td>
    <td>${m.player2_name}</td>
    <td>${upScore.player2Up}</td>
    <td><a href="matchscreen.html?matchId=${m.id}">Open Match</a></td>
  `;
  matchesBody.appendChild(row);
}
    }

    // Nieuwe match toevoegen
    addMatchBtn.onclick = async () => {
      const p1Name = newPlayer1Input.value.trim();
      const p2Name = newPlayer2Input.value.trim();
      if (!p1Name || !p2Name) return alert("Vul beide spelers in");

      // Spelers aanmaken
      const p1 = await fetch(`${apiUrl}/players`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name: p1Name }),
      }).then(r => r.json());

      const p2 = await fetch(`${apiUrl}/players`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name: p2Name }),
      }).then(r => r.json());

      // Match aanmaken
      await fetch(`${apiUrl}/matches`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ player1_id: p1.id, player2_id: p2.id }),
      });

      // Velden leegmaken en dashboard refreshen
      newPlayer1Input.value = "";
      newPlayer2Input.value = "";
      loadDashboard();
    };

    loadDashboard();
    setInterval(loadDashboard, 3000); // elke 3 seconden live update
  </script>
</body>
</html>